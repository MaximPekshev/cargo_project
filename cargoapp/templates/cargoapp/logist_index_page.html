{% extends 'cargoapp/base.html' %}

{% block content %}
<nav class="fixed-bottom navbar-dark bg-dark">
	{% comment %} <a class="navbar-brand" type="button" data-bs-toggle="modal" data-bs-target="#modalLogout" style="float: right;" >Выйти</a> {% endcomment %}
	<a class="navbar-brand" href="{% url "show_menu_page" %}" style="float: right;" >Меню</a>
	<a class="navbar-brand" type="button" data-bs-toggle="modal" data-bs-target="#modalCalc" style="float: right;" >Расчет маршрута</a>
</nav>
<div class="row pt-3 justify-content-between">
	<div class="col-12 col-md-12 col-lg-10" align="left">
		<form id="super_logist_form" class="row justify-content-between" action="{% url 'show_index_page' %}" method="GET" >
			{% if actual_vehicle %}
			<div class="col-12 col-md-1 align-self-center pb-1">
				<a style="width: 100%;" class="btn btn-dark btn-sm as-34px" href="{% url 'show_new_route_form' %}?vehicle={{ actual_vehicle.uid }}">+</a>
			</div>
			{% endif %}
			<div class="col-6 col-md-4 align-self-center pb-1">
				<select class="js-example-basic-single form-control" name="vehicle" id="vehicle">
					{% if checked_vehicle %}
					<option value="">...</option>
					<option selected value="{{ checked_vehicle.uid }}">{{ checked_vehicle }}</option>
					{% else %}
					<option selected value="">...</option>
					{% endif %}
					{% for vehicle in vehicles %}
					<option value="{{ vehicle.uid }}">{{ vehicle.car_number }}</option>
					{% endfor %}
				</select>
			</div>
			<div class="col-6 col-md-4 align-self-center pb-1">
				<input type="month" id="month" name="month" min="2021-10" class="form-control as-34px" value="{{ actual_month }}">
			</div> 
			<div style="margin-left:0; margin-right:0;" class="row pb-1 {% if actual_vehicle %} col-12 col-md-3 {% else %} col-12 col-md-4 {% endif %} justify-content-lg-start justify-content-between">
				<div class="col-6 col-md-6 align-self-center">
					<button style="width: 100%;" type="submit" class="btn btn-dark btn-sm as-34px">Отобрать</button>
				</div>
				<div class="col-6 col-md-6 align-self-center">
					<a style="width: 100%;" class="btn btn-dark btn-sm as-34px" href="{% url 'show_index_page' %}">Очистить</a>
				</div>
			</div>
		</form>
	</div>
	<div class="col-12 col-md-12 col-lg-2" align="right">Логист: {{ user.username }}</div>
</div>
<div class="row justify-content-center">
		<table class="table table-sm col-12">
			<thead style="position: sticky; top: 0; background-color: white;">
				<tr>
					<th>#</th>
					<th width="7%">Дата с</th>
					<th width="7%">Дата по</th>
					<th>Кол-во дней</th>
					<th width="10%">Авто</th>
					<th>Маршрут</th>
					<th>Пробег, км</th>
					<th>Валовый доход, руб</th>
					<th>Топливо, руб</th>
					<th>Зарплата/командир, руб</th>
					<th>Прочие расходы, руб</th>
					<th>Чистый доход, руб</th>
					<th>Цена за км, руб/км</th>
					<th>Платон</th>
					<th>Прямые</th>
				</tr>
			</thead>
			<tbody>
				{% for item in routes %}
				<!-- <tr onclick="window.location.href='{% url 'show_route' uid=item.uid %}'; return false"> -->
				<tr>
					<td>{{ item.id }}</td>
					<td>{{ item.from_date|date:"Y-m-d" }}</td>
					<td>{{ item.to_date|date:"Y-m-d" }}</td>
					<td>{{ item.day_count }}</td>
					<td>{{ item.vehicle }}</td>
					<td><a href="{% url 'show_route' uid=item.uid %}">{{ item.a_point }} - {{ item.b_point }}</a></td>
					<td>{{ item.route_length }}</td>
					<td>{{ item.route_cost }}</td>
					<td>{{ item.fuel_cost }}</td>
					<td>{{ item.pay_check }}</td>
					<td>{{ item.expenses_1 }}</td>
					<td>{{ item.straight }}</td>
					<td>{{ item.cost_of_km }}</td>
					<td>{{ item.cost_of_platon }}</td>
					<td>{{ item.get_straight }}</td>
				</tr>
				{% endfor %}
				<tr style="background-color: #ffff99;">
					<td colspan="2">Итого (факт)</td>
					<td></td>
					<td>{{ total_days }}</td>
					<td></td>
					<td></td>
					<td>{{ total_route_length }}</td>
					<td>{{ total_route_cost }}</td>
					<td>{{ total_fuel_cost }}</td>
					<td>{{ total_pay_check }}</td>
					<td>{{ total_expenses_1 }}</td>
					<td>{{ total_pure_income }}</td>
					<td>{{ total_cost_of_km }}</td>
					<td>{{ total_cost_of_platon }}</td>
					<td></td>
				</tr>

				<tr style="background-color: #ccffcc;">
					<td colspan="2">Итого (план)</td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td>{{ plan_total_route_length }}</td>
					<td>{{ plan_total_route_cost }}</td>
					<td></td>
					<td></td>
					<td></td>
					<td>{{ plan_total_pure_income }}</td>
					<td>{{ plan_total_cost_of_km }}</td>
					<td></td>
					<td></td>
				</tr>
				<tr style="background-color: #99ccff;">
					<td colspan="2">Остаток до плана</td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td>{{ route_length_diff }}</td>
					<td>{{ route_cost_diff }}</td>
					<td></td>
					<td></td>
					<td></td>
					<td>{{ pure_income_diff }}</td>
					<td>{{ cost_of_km_diff }}</td>
					<td></td>
					<td></td>
				</tr>
				<tr>
					<td colspan="2">% выполнения</td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td>{{ route_length_percent }}%</td>
					<td>{{ route_cost_percent }}%</td>
					<td></td>
					<td></td>
					<td></td>
					<td>{{ pure_income_percent }}%</td>
					<td>{{ cost_of_km_percent }}%</td>
					<td></td>
					<td></td>
				</tr>
			</tbody>
		</table>		
	<div class="pb-5"></div>
</div>



<!-- Modal -->
<div class="modal fade" id="modalLogout" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="modalLogoutLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
	  <div class="modal-content">
		<div class="modal-header">
		  <h5 class="modal-title" id="modalLogoutLabel">Вы уверены что хотите выйти?</h5>
		  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		</div>
		<div class="modal-footer">
		  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
		  <a href="{% url 'logout' %}" class="btn btn-primary">Выйти</a>
		</div>
	  </div>
	</div>
</div>

<div class="modal" id="modalCalc" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="modalLogoutLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
	  <div class="modal-content">
		<div class="modal-header">
		  <h5 class="modal-title" id="modalLogoutLabel">Калькулятор маршрута</h5>
		  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		</div>
		<div class="modal-body row" id="routeCalculator">
			<div class="form-group col-6">
				<label for="fuel_consum">Расход топлива, л.</label>
				<input onKeyPress="inputFilter()" type="text" class="form-control" id="fuel_consum" placeholder="Расход топлива" value="34">
			</div>
			<div class="form-group col-6">
				<label for="salary">Коэффициент ЗП</label>
				<input onKeyPress="inputFilter()" type="text" class="form-control" id="salary" placeholder="Коэффициент ЗП+командировочные" value="8">
			</div>
			<div class="form-group col-6 mb-4">
				<label for="fuel_cost">Стоимость топлива, руб.</label>
				<input onKeyPress="inputFilter()" type="text" class="form-control" id="fuel_cost" placeholder="Стоимость топлива" value="52">
			</div>
			<div class="form-group col-6">
				<label for="platon">Платон коэффициент</label>
				<input onKeyPress="inputFilter()" type="text" class="form-control" id="platon" placeholder="Платон" value="2.34">
			</div>

			<div class="form-group col-6">
				<label for="mileage">Пробег, км</label>
				<input onKeyPress="inputFilter()" type="text" class="form-control" id="mileage" placeholder="">
			</div>
			<div class="form-group col-6 ">
				<label for="income">Валовый доход, руб</label>
				<input onKeyPress="inputFilter()" type="text" class="form-control" id="income" placeholder="">
			</div>
			<div class="form-group col-12 mb-4">
				<label for="other">Прочие расходы, руб</label>
				<input onKeyPress="inputFilter()" type="text" class="form-control" id="other" placeholder="">
			</div>


			<div class="form-group col-6">
				<label for="calcFuel">Диз. Топливо, руб</label>
				<input type="text" class="form-control" id="calcFuel" placeholder="..." disabled>
			</div>
			<div class="form-group col-6">
				<label for="calcSalary">Зарплата/ командир, руб</label>
				<input type="text" class="form-control" id="calcSalary" placeholder="..." disabled>
			</div>

			<div class="form-group col-6">
				<label for="calcPureIncome">Чистый доход, руб</label>
				<input type="text" class="form-control" id="calcPureIncome" placeholder="..." disabled>
			</div>
			<div class="form-group col-6">
				<label for="calcKMPrice">Цена за км, руб/км</label>
				<input type="text" class="form-control" id="calcKMPrice" placeholder="..." disabled>
			</div>
			<div class="form-group col-6">
				<label for="calcPlaton">Платон, руб</label>
				<input type="text" class="form-control" id="calcPlaton" placeholder="..." disabled>
			</div>
		</div>
		<div class="modal-footer">
		  <button id="calculate" type="button" class="btn btn-secondary">Рассчитать</button>
		  <a data-bs-dismiss="modal" class="btn btn-primary">Закрыть</a>
		</div>
	  </div>
	</div>
</div>

{% endblock %}

{% block custom_script %}
<script type="text/javascript">

    window.onload = function() {
        document.getElementById('calculate').addEventListener('click', calculateRoute, false);
    };

    const calculateRoute = async (evt) => {
        evt.preventDefault();
        let routeCalculator = document.getElementById('routeCalculator');
		let flag = false;

		let fuel_consum = document.getElementById('fuel_consum');
		if (fuel_consum != null&& !fuel_consum.value == "") {
			fuel_consum = parseFloat(fuel_consum.value).toFixed(2);
		} else {
			fuel_consum.placeholder = "Обязательное поле!!";
			flag = true;
		}

		let salary = document.getElementById('salary');
		if (salary != null&& !salary.value == "") {
			salary = parseFloat(salary.value).toFixed(2);
		} else {
			salary.placeholder = "Обязательное поле!!";
			flag = true;
		}

		let fuel_cost = document.getElementById('fuel_cost');
		if (fuel_cost != null&& !fuel_cost.value == "") {
			fuel_cost = parseFloat(fuel_cost.value).toFixed(2);
		} else {
			fuel_cost.placeholder = "Обязательное поле!!";
			flag = true;
		}

		let platon = document.getElementById('platon');
		if (platon != null&& !platon.value == "") {
			platon = parseFloat(platon.value).toFixed(2);
		} else {
			platon.placeholder = "Обязательное поле!!";
			flag = true;
		}

		let mileage = document.getElementById('mileage');
		if (mileage != null&& !mileage.value == "") {
			mileage = parseFloat(mileage.value).toFixed(2);
		} else {
			mileage.placeholder = "Обязательное поле!!";
			flag = true;
		}

		let income = document.getElementById('income');
		if (income != null&& !income.value == "") {
			income = parseFloat(income.value).toFixed(2);
		} else {
			income.placeholder = "Обязательное поле!!";
			flag = true;
		}

		let other = document.getElementById('other');
		if (other != null&& !other.value == "") {
			other = parseFloat(other.value).toFixed(2);
		} else {
			other =  parseFloat("0").toFixed(2);
		}
		
		if (!flag) {
			let calcFuel = fuel_consum*mileage/100*fuel_cost;
			let valFuelCost = document.getElementById('calcFuel');
			valFuelCost.value = calcFuel;

			let calcSalary = mileage*salary;
			let valSalary = document.getElementById('calcSalary');
			valSalary.value = calcSalary;


			let calcPlaton = mileage*platon;
			let valPlaton = document.getElementById('calcPlaton');
			valPlaton.value = calcPlaton;
			
			let calcPureIncome = income-calcFuel-calcSalary-other-calcPlaton;
			let valPureIncome = document.getElementById('calcPureIncome');
			valPureIncome.value = calcPureIncome;

			let calcKMPrice = income/mileage;
			let valKMPrice = document.getElementById('calcKMPrice');
			valKMPrice.value = calcKMPrice.toFixed(2);

		} else {
			document.getElementById('calcFuel').value = "";
			document.getElementById('calcSalary').value = "";
			document.getElementById('calcPureIncome').value = "";
			document.getElementById('calcKMPrice').value = "";
			document.getElementById('calcPlaton').value = "";
		}
        
    };

	function inputFilter(){
		if (event.keyCode < 48 || event.keyCode > 57) {
			console.log(event.keyCode);
			if (event.keyCode != 46){
				event.returnValue= false;
			}
		}
		
	};
	
</script>
{% endblock %}